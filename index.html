<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buse'nin Zaman Kaps√ºl√º√º ‚ù§Ô∏è</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');
        :root { --primary: #ff8fa3; --bg: #fff0f3; --white: #ffffff; --text: #4a4a4a; --locked: #e0e0e0; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        .container { width: 100%; height: 100%; position: absolute; top: 0; left: 0; transition: 0.3s; }
        .hidden { display: none !important; }
        
        /* Giri≈ü Ekranƒ± */
        #auth-container { display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        .auth-box { background: var(--white); padding: 2rem; border-radius: 20px; width: 85%; max-width: 320px; text-align: center; box-shadow: 0 10px 30px rgba(255, 107, 129, 0.2); }
        .auth-box h1 { color: #ff6b81; font-size: 1.5rem; margin-bottom: 5px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ffe3e3; border-radius: 12px; outline: none; text-align: center; }
        input:focus { border-color: var(--primary); }
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        button:active { transform: scale(0.98); }

        /* Uygulama ƒ∞√ßi */
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: var(--white); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .capsule-list { padding: 20px; overflow-y: auto; height: calc(100vh - 70px); padding-bottom: 80px; }
        
        /* KAPS√úL KARTLARI */
        .capsule-card { background: var(--white); padding: 20px; margin-bottom: 15px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); border: 1px solid #ffe3e3; transition: 0.3s; position: relative; overflow: hidden; }
        
        /* Kilitli Kaps√ºl Tasarƒ±mƒ± */
        .capsule-card.locked { background: #f4f4f4; border-color: #ddd; }
        .capsule-card.locked .content-blur { filter: blur(5px); opacity: 0.5; user-select: none; }
        .lock-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; }
        .countdown { font-weight: bold; color: #ff6b81; font-size: 1.1rem; background: white; padding: 5px 15px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-top: 10px; }
        
        /* A√ßƒ±k Kaps√ºl Tasarƒ±mƒ± */
        .capsule-card.unlocked { border-left: 5px solid var(--primary); animation: slideIn 0.5s ease; }
        .unlock-badge { background: #d4edda; color: #155724; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: bold; display: inline-block; margin-bottom: 5px; }

        @keyframes slideIn { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: flex-end; justify-content: center; z-index: 99; }
        .modal-content { background: var(--white); width: 100%; max-width: 500px; border-radius: 25px 25px 0 0; padding: 25px; }
        textarea { width: 100%; height: 100px; padding: 10px; border: 2px solid #eee; border-radius: 10px; resize: none; margin-bottom: 10px; }
        
        @media (min-width: 768px) { .modal { align-items: center; } .modal-content { border-radius: 25px; width: 400px; } #app-container { max-width: 600px; margin: 0 auto; background: #fff; height: 100vh; position: relative; } }
    </style>
</head>
<body>

    <div id="auth-container" class="container">
        <div class="auth-box">
            <h1>Ho≈ü Geldin üå∏</h1>
            <p style="color:#aaa; font-size:0.9rem; margin-bottom:15px;">Bu kaps√ºl sana √∂zel.</p>
            
            <input type="text" id="username" placeholder="Adƒ±n ne?">
            <input type="password" id="password" placeholder="≈ûifren?">
            <button onclick="checkLogin()">Giri≈ü Yap</button>
            <p id="error-msg" style="color:red; font-size:0.8rem; margin-top:10px;"></p>
        </div>
    </div>

    <div id="app-container" class="container hidden">
        <header>
            <div style="font-weight:bold; color:var(--primary);">Buse'nin Anƒ±larƒ±</div>
            <i class="fas fa-plus-circle" onclick="openModal()" style="font-size:1.8rem; color:var(--primary); cursor:pointer;"></i>
        </header>

        <div id="capsule-list" class="capsule-list">
            <div style="text-align:center; margin-top:50px; color:#ccc;">Y√ºkleniyor...</div>
        </div>
        
        <div id="create-modal" class="modal hidden">
            <div class="modal-content">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                    <h3>Yeni Anƒ± Ekle</h3>
                    <span onclick="closeModal()" style="font-size:1.5rem;">&times;</span>
                </div>
                <textarea id="capsule-text" placeholder="Geleceƒüe bir not bƒ±rak..."></textarea>
                
                <label style="font-size:0.8rem; color:#666;">Ne zaman a√ßƒ±lsƒ±n?</label>
                <input type="datetime-local" id="capsule-date" style="text-align:left;">
                
                <button onclick="saveCapsule()" id="save-btn">M√ºh√ºrle ve Sakla üîí</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // --- SENƒ∞N VERDƒ∞ƒûƒ∞N API AYARLARI ---
        const firebaseConfig = {
          apiKey: "AIzaSyCD_dKXan4yjAzxqLc8Yfjx4JzXNne45Lk",
          authDomain: "zamankaps.firebaseapp.com",
          projectId: "zamankaps",
          storageBucket: "zamankaps.firebasestorage.app",
          messagingSenderId: "167594541047",
          appId: "1:167594541047:web:b61c2ba198c07c69c8b8f2",
          measurementId: "G-268PLLLDRD"
        };

        // Firebase Ba≈ülat
        try {
            firebase.initializeApp(firebaseConfig);
        } catch (e) {
            console.error("Firebase Hatasƒ±: " + e.message);
        }
        
        const db = firebase.firestore();
        const FIXED_USER_ID = "buse_ozel_kullanici"; 

        // --- Gƒ∞Rƒ∞≈û KONTROL√ú ---
        function checkLogin() {
            const user = document.getElementById('username').value.trim().toLowerCase();
            const pass = document.getElementById('password').value.trim();
            const error = document.getElementById('error-msg');

            if (user === "buse" && pass === "buse2525") {
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                loadCapsules();
            } else {
                error.innerText = "Hatalƒ± bilgi girdin tatlƒ±m. Tekrar dene. üßê";
                setTimeout(() => error.innerText = "", 3000);
            }
        }

        // --- VERƒ∞TABANI VE GERƒ∞ SAYIM ƒ∞≈ûLEMLERƒ∞ ---
        
        function loadCapsules() {
            const list = document.getElementById('capsule-list');
            list.innerHTML = '<div style="text-align:center; margin-top:50px; color:#ccc;">Anƒ±lar aranƒ±yor...</div>';

            db.collection('capsules')
              .where("userId", "==", FIXED_USER_ID)
              .orderBy("openDate", "asc")
              .onSnapshot((snapshot) => { // onSnapshot ile anlƒ±k g√ºncelleme alƒ±yoruz
                  list.innerHTML = "";
                  if (snapshot.empty) {
                      list.innerHTML = '<div style="text-align:center; margin-top:50px; color:#ccc;">Hen√ºz hi√ß anƒ± yok. <br>Saƒü √ºstten + ile ekle! üå∏</div>';
                      return;
                  }

                  snapshot.forEach(doc => {
                      const data = doc.data();
                      if(!data.openDate) return;
                      
                      // Timestamp'i milisaniyeye √ßevirip data attribute olarak saklayacaƒüƒ±z
                      const targetTime = data.openDate.toDate().getTime(); 
                      const uniqueId = doc.id;

                      // Kart iskeletini olu≈ütur (ƒ∞√ßeriƒüi timer fonksiyonu dolduracak)
                      list.innerHTML += `
                        <div id="card-${uniqueId}" class="capsule-card locked" data-target="${targetTime}">
                            
                            <div id="lock-layer-${uniqueId}" class="lock-overlay">
                                <i class="fas fa-lock" style="font-size:2rem; color:#aaa;"></i>
                                <div class="countdown" id="timer-${uniqueId}">Hesaplanƒ±yor...</div>
                            </div>

                            <div id="content-${uniqueId}" class="content-blur">
                                <div style="display:flex; justify-content:space-between; color:var(--primary); font-size:0.8rem; margin-bottom:5px;">
                                    <span class="unlock-badge">‚ú® ANI A√áILDI</span>
                                    <span>${data.openDate.toDate().toLocaleDateString()}</span>
                                </div>
                                <div style="color:#555; line-height:1.4; font-size:1.1rem;">${data.text}</div>
                            </div>
                        </div>`;
                  });
                  
                  // Sayacƒ± hemen ba≈ülat
                  startCountdownLoop();
              });
        }

        // --- GERƒ∞ SAYIM MOTORU ---
        function startCountdownLoop() {
            // Var olan bir d√∂ng√º varsa temizle (√ºst √ºste binmesin)
            if(window.timerInterval) clearInterval(window.timerInterval);

            window.timerInterval = setInterval(() => {
                const now = new Date().getTime();
                const cards = document.querySelectorAll('.capsule-card');

                cards.forEach(card => {
                    const target = parseInt(card.getAttribute('data-target'));
                    const uniqueId = card.id.replace('card-', '');
                    const timerEl = document.getElementById(`timer-${uniqueId}`);
                    const lockLayer = document.getElementById(`lock-layer-${uniqueId}`);
                    const contentLayer = document.getElementById(`content-${uniqueId}`);
                    
                    const distance = target - now;

                    if (distance < 0) {
                        // --- S√úRE DOLDU! Kƒ∞Lƒ∞Dƒ∞ A√á ---
                        if(card.classList.contains('locked')) {
                            card.classList.remove('locked');
                            card.classList.add('unlocked');
                            lockLayer.style.display = 'none'; // Kilidi kaldƒ±r
                            contentLayer.classList.remove('content-blur'); // Bulanƒ±klƒ±ƒüƒ± kaldƒ±r
                        }
                    } else {
                        // --- S√úRE VAR, GERƒ∞ SAY ---
                        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                        timerEl.innerHTML = `${days}g ${hours}s ${minutes}dk ${seconds}sn`;
                    }
                });
            }, 1000); // Her 1 saniyede bir g√ºncelle
        }

        async function saveCapsule() {
            const text = document.getElementById('capsule-text').value;
            const dateVal = document.getElementById('capsule-date').value;
            const btn = document.getElementById('save-btn');

            if (!text) return alert("Bo≈ü anƒ± olmaz! Bir ≈üeyler yaz.");
            if (!dateVal) return alert("Ne zaman a√ßƒ±lacaƒüƒ±nƒ± se√ßmelisin.");

            btn.innerText = "Y√ºkleniyor...";
            btn.disabled = true;

            try {
                await db.collection('capsules').add({
                    userId: FIXED_USER_ID,
                    text: text,
                    openDate: firebase.firestore.Timestamp.fromDate(new Date(dateVal)),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                closeModal();
                document.getElementById('capsule-text').value = "";
                alert("Anƒ± m√ºh√ºrlendi! Zamanƒ± gelince a√ßƒ±lacak. ‚è≥");
                // onSnapshot kullandƒ±ƒüƒ±mƒ±z i√ßin loadCapsules() √ßaƒüƒ±rmaya gerek yok, otomatik yenilenir.

            } catch (error) {
                alert("Hata olu≈ütu: " + error.message);
            } finally {
                btn.innerText = "M√ºh√ºrle ve Sakla üîí";
                btn.disabled = false;
            }
        }

        function openModal() {
            document.getElementById('create-modal').classList.remove('hidden');
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('capsule-date').min = now.toISOString().slice(0,16);
        }
        function closeModal() { document.getElementById('create-modal').classList.add('hidden'); }
    </script>
</body>
</html>
