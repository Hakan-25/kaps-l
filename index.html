<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buse'nin Zaman Kaps√ºl√º ‚ù§Ô∏è</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');
        :root { --primary: #ff8fa3; --secondary: #a2d9ff; --bg: #fff0f3; --white: #ffffff; --text: #4a4a4a; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        .container { width: 100%; height: 100%; position: absolute; top: 0; left: 0; transition: 0.3s; }
        .hidden { display: none !important; }
        
        /* Giri≈ü Ekranƒ± */
        #auth-container { display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        .auth-box { background: var(--white); padding: 2rem; border-radius: 20px; width: 85%; max-width: 320px; text-align: center; box-shadow: 0 10px 30px rgba(255, 107, 129, 0.2); }
        .auth-box h1 { color: #ff6b81; font-size: 1.5rem; margin-bottom: 5px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ffe3e3; border-radius: 12px; outline: none; text-align: center; }
        input:focus { border-color: var(--primary); }
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        button:active { transform: scale(0.98); }

        /* Uygulama ƒ∞√ßi */
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: var(--white); box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 10; position: relative; }
        .capsule-list { padding: 20px; overflow-y: auto; height: calc(100vh - 70px); padding-bottom: 80px; }
        
        /* --- BULUT KAPS√úL TASARIMI --- */
        .cloud-card { 
            background: linear-gradient(to top, #f0f8ff, #ffffff); 
            padding: 25px 20px; 
            margin-bottom: 25px; 
            border-radius: 30px; /* Bulut yuvarlaklƒ±ƒüƒ± */
            box-shadow: 0 8px 20px rgba(162, 217, 255, 0.3); 
            border: 2px solid #e6f7ff; 
            text-align: center;
            position: relative;
            transition: 0.3s;
        }

        /* G√∂rsel Alanƒ± */
        .cloud-icon-area { margin-bottom: 10px; position: relative; height: 60px; display: flex; align-items: center; justify-content: center; }
        .fa-cloud { font-size: 4rem; color: var(--secondary); filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1)); }
        .lock-icon { position: absolute; font-size: 1.2rem; color: #555; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        /* Saya√ß Rozeti */
        .timer-badge { 
            background: var(--white); 
            color: #555; 
            font-family: 'Courier New', monospace; 
            font-weight: bold; 
            padding: 8px 15px; 
            border-radius: 20px; 
            border: 1px solid #ddd;
            display: inline-block;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        /* A√ßma Butonu (Ba≈ülangƒ±√ßta Gizli) */
        .open-btn { 
            background: linear-gradient(45deg, #ff9a9e, #ff6b81); 
            color: white; 
            border: none; 
            padding: 10px 25px; 
            border-radius: 25px; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 0 4px 10px rgba(255, 107, 129, 0.4);
            animation: pulse 1.5s infinite;
            display: none; 
            margin-top: 10px;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Gizli ƒ∞√ßerik (A√ßƒ±ldƒ±ktan Sonra G√∂r√ºn√ºr) */
        .secret-content { 
            display: none; 
            text-align: left; 
            margin-top: 15px; 
            background: rgba(255,255,255,0.9); 
            padding: 20px; 
            border-radius: 15px; 
            border-left: 5px solid var(--primary);
            animation: fadeIn 0.8s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: flex-end; justify-content: center; z-index: 99; }
        .modal-content { background: var(--white); width: 100%; max-width: 500px; border-radius: 25px 25px 0 0; padding: 25px; }
        textarea { width: 100%; height: 100px; padding: 10px; border: 2px solid #eee; border-radius: 10px; resize: none; margin-bottom: 10px; }
        
        @media (min-width: 768px) { .modal { align-items: center; } .modal-content { border-radius: 25px; width: 400px; } #app-container { max-width: 600px; margin: 0 auto; background: #fff; height: 100vh; position: relative; } }
    </style>
</head>
<body>

    <div id="auth-container" class="container">
        <div class="auth-box">
            <h1>Ho≈ü Geldin üå∏</h1>
            <p style="color:#aaa; font-size:0.9rem; margin-bottom:15px;">Bu kaps√ºl sana √∂zel.</p>
            
            <input type="text" id="username" placeholder="Adƒ±n ne?">
            <input type="password" id="password" placeholder="≈ûifren?">
            <button onclick="checkLogin()">Giri≈ü Yap</button>
            <p id="error-msg" style="color:red; font-size:0.8rem; margin-top:10px;"></p>
        </div>
    </div>

    <div id="app-container" class="container hidden">
        <header>
            <div style="font-weight:bold; color:var(--primary);">Buse'nin Anƒ±larƒ±</div>
            <i class="fas fa-plus-circle" onclick="openModal()" style="font-size:1.8rem; color:var(--primary); cursor:pointer;"></i>
        </header>

        <div id="capsule-list" class="capsule-list">
            <div style="text-align:center; margin-top:50px; color:#ccc;">Bulutlar taranƒ±yor... ‚òÅÔ∏è</div>
        </div>
        
        <div id="create-modal" class="modal hidden">
            <div class="modal-content">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                    <h3>Yeni Anƒ± Ekle</h3>
                    <span onclick="closeModal()" style="font-size:1.5rem;">&times;</span>
                </div>
                <textarea id="capsule-text" placeholder="Geleceƒüe bir not bƒ±rak..."></textarea>
                
                <label style="font-size:0.8rem; color:#666;">Ne zaman a√ßƒ±lsƒ±n?</label>
                <input type="datetime-local" id="capsule-date" style="text-align:left;">
                
                <button onclick="saveCapsule()" id="save-btn">Buluta G√∂nder ‚òÅÔ∏è</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // --- SENƒ∞N API Bƒ∞LGƒ∞LERƒ∞N (D√úZELTƒ∞LDƒ∞: c harfi C yapƒ±ldƒ±) ---
        const firebaseConfig = {
          apiKey: "AIzaSyCD_dKXan4yjAzxqLC8Yfjx4JzXNne45Lk",
          authDomain: "zamankaps.firebaseapp.com",
          projectId: "zamankaps",
          storageBucket: "zamankaps.firebasestorage.app",
          messagingSenderId: "167594541047",
          appId: "1:167594541047:web:b61c2ba198c07c69c8b8f2",
          measurementId: "G-268PLLLDRD"
        };

        // Firebase Ba≈ülatma
        try {
            firebase.initializeApp(firebaseConfig);
        } catch (e) {
            console.error("Firebase ba≈ülatƒ±lamadƒ±:", e);
        }
        
        const db = firebase.firestore();
        const FIXED_USER_ID = "buse_ozel_kullanici"; 

        // --- Gƒ∞Rƒ∞≈û KONTROL√ú ---
        function checkLogin() {
            const user = document.getElementById('username').value.trim().toLowerCase();
            const pass = document.getElementById('password').value.trim();
            const error = document.getElementById('error-msg');

            if (user === "buse" && pass === "buse2525") {
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                loadCapsules();
            } else {
                error.innerText = "Hatalƒ± bilgi girdin tatlƒ±m. Tekrar dene. üßê";
                setTimeout(() => error.innerText = "", 3000);
            }
        }

        // --- BULUTLARI Y√úKLEME VE Lƒ∞STELEME ---
        function loadCapsules() {
            const list = document.getElementById('capsule-list');

            // Veritabanƒ±nƒ± dinle (Canlƒ± g√ºncellenir)
            db.collection('capsules')
              .where("userId", "==", FIXED_USER_ID)
              .orderBy("openDate", "asc")
              .onSnapshot((snapshot) => { 
                  list.innerHTML = "";
                  
                  if (snapshot.empty) {
                      list.innerHTML = '<div style="text-align:center; margin-top:50px; color:#ccc;">Hen√ºz hi√ß bulut yok. <br>Saƒü √ºstten + ile ekle! ‚òÅÔ∏è</div>';
                      return;
                  }

                  snapshot.forEach(doc => {
                      const data = doc.data();
                      if(!data.openDate) return;
                      
                      const targetTime = data.openDate.toDate().getTime(); 
                      const uniqueId = doc.id;

                      // HTML ≈ûABLONU (Bulut G√∂r√ºn√ºm√º)
                      list.innerHTML += `
                        <div id="cloud-${uniqueId}" class="cloud-card" data-target="${targetTime}">
                            
                            <div id="visual-${uniqueId}" class="cloud-icon-area">
                                <i class="fas fa-cloud"></i>
                                <i class="fas fa-lock lock-icon"></i>
                            </div>

                            <div style="font-size:0.8rem; color:#888; margin-bottom:5px;">
                                A√ßƒ±lma Zamanƒ±: ${data.openDate.toDate().toLocaleDateString()} ${data.openDate.toDate().toLocaleTimeString().slice(0,5)}
                            </div>

                            <div id="timer-${uniqueId}" class="timer-badge">Hesaplanƒ±yor...</div>

                            <button id="btn-${uniqueId}" class="open-btn" onclick="revealContent('${uniqueId}')">
                                Kaps√ºl√º A√ß üîì
                            </button>

                            <div id="content-${uniqueId}" class="secret-content">
                                <h4 style="color:var(--primary); margin-bottom:10px;">Sevgili Buse,</h4>
                                <p style="line-height:1.5; font-size:1.05rem;">${data.text}</p>
                            </div>
                        </div>`;
                  });
                  
                  // Saya√ß d√∂ng√ºs√ºn√º ba≈ülat
                  startCountdownLoop();
              }, (error) => {
                  console.error("Veri √ßekme hatasƒ±:", error);
                  list.innerHTML = '<div style="text-align:center; color:red;">Baƒülantƒ± hatasƒ± oldu :( <br> <small>' + error.message + '</small></div>';
              });
        }

        // --- MANUEL A√áMA (ƒ∞STEƒûE BAƒûLI) ---
        function revealContent(id) {
            // Butonu gizle, i√ßeriƒüi g√∂ster
            document.getElementById(`btn-${id}`).style.display = 'none';
            document.getElementById(`content-${id}`).style.display = 'block';
            
            // G√∂rseli g√ºncelle: Bulutun i√ßinden g√ºne≈ü √ßƒ±ksƒ±n ‚òÄÔ∏è
            const visualArea = document.getElementById(`visual-${id}`);
            visualArea.innerHTML = '<i class="fas fa-cloud-sun" style="font-size:4rem; color:#ffdd59;"></i>';
        }

        // --- GERƒ∞ SAYIM MOTORU (Her saniye √ßalƒ±≈üƒ±r) ---
        function startCountdownLoop() {
            if(window.timerInterval) clearInterval(window.timerInterval);

            window.timerInterval = setInterval(() => {
                const now = new Date().getTime();
                const clouds = document.querySelectorAll('.cloud-card');

                clouds.forEach(cloud => {
                    const target = parseInt(cloud.getAttribute('data-target'));
                    const id = cloud.id.replace('cloud-', '');
                    
                    const timerEl = document.getElementById(`timer-${id}`);
                    const btnEl = document.getElementById(`btn-${id}`);
                    const contentEl = document.getElementById(`content-${id}`);
                    
                    const distance = target - now;

                    // Eƒüer i√ßerik zaten a√ßƒ±lmƒ±≈üsa sayacƒ± gizle
                    if(contentEl.style.display === 'block') {
                        timerEl.style.display = 'none';
                        return;
                    }

                    if (distance < 0) {
                        // --- S√úRE DOLDU! ---
                        timerEl.style.display = 'none'; // Sayacƒ± kaldƒ±r
                        
                        // Eƒüer hen√ºz a√ßƒ±lmadƒ±ysa BUTONU G√ñSTER
                        if(contentEl.style.display !== 'block') { 
                            btnEl.style.display = 'inline-block';
                        }
                    } else {
                        // --- S√úRE VAR, GERƒ∞ SAY ---
                        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                        timerEl.innerHTML = `${days}g ${hours}s ${minutes}dk ${seconds}sn`;
                        btnEl.style.display = 'none'; // Butonu gizli tut
                    }
                });
            }, 1000);
        }

        // --- KAYDETME FONKSƒ∞YONU ---
        async function saveCapsule() {
            const text = document.getElementById('capsule-text').value;
            const dateVal = document.getElementById('capsule-date').value;
            const btn = document.getElementById('save-btn');

            if (!text) return alert("Bo≈ü anƒ± olmaz! Bir ≈üeyler yaz.");
            if (!dateVal) return alert("Ne zaman a√ßƒ±lacaƒüƒ±nƒ± se√ßmelisin.");

            btn.innerText = "Y√ºkleniyor...";
            btn.disabled = true;

            try {
                // Veritabanƒ±na ekle
                await db.collection('capsules').add({
                    userId: FIXED_USER_ID, 
                    text: text,
                    openDate: firebase.firestore.Timestamp.fromDate(new Date(dateVal)),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                closeModal();
                document.getElementById('capsule-text').value = "";
                alert("Anƒ± buluta g√∂nderildi! ‚òÅÔ∏è");
                
            } catch (error) { 
                alert("Hata olu≈ütu: " + error.message); 
                console.error("Kayƒ±t hatasƒ±:", error);
            } finally { 
                btn.innerText = "Buluta G√∂nder ‚òÅÔ∏è"; 
                btn.disabled = false; 
            }
        }

        function openModal() {
            document.getElementById('create-modal').classList.remove('hidden');
            const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('capsule-date').min = now.toISOString().slice(0,16);
        }
        function closeModal() { document.getElementById('create-modal').classList.add('hidden'); }
    </script>
</body>
</html>
